name: Aggregate Standup Reports

on:
  schedule:
    # Runs every weekday (Monday to Friday) at 10:30 AM PST (5:30 AM UTC)
    - cron: '30 5 * * 1-5'
  workflow_dispatch:

jobs:
  aggregate-standups:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
          sudo apt-add-repository https://cli.github.com/packages
          sudo apt update
          sudo apt install gh -y

      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo $GITHUB_TOKEN | gh auth login --with-token

      - name: Fetch Standup Issues
        run: |
          gh issue list --label standup --state open --limit 10 > standup_issues.txt

      - name: Create Summary Issue
        id: create_summary_issue
        uses: peter-evans/create-issue@v4
        with:
          title: "Standup Summary - $(date +'%Y-%m-%d')"
          body: |
            **Standup Summary for $(date +'%Y-%m-%d')**

            $(cat standup_issues.txt | while read -r line; do
              issue_number=$(echo "$line" | awk '{print $1}')
              issue_title=$(echo "$line" | cut -d' ' -f2-)
              echo "- [#${issue_number}] ${issue_title}"
            done)
          labels: 'standup-summary'

      # Optional: Close Standup Issues After Summarizing
      - name: Close Standup Issues
        if: success()
        run: |
          while read -r line; do
            issue_number=$(echo "$line" | awk '{print $1}')
            gh issue close $issue_number
          done < standup_issues.txt

      # Notify Slack about the created Standup Summary
      - name: Send Notification to Slack
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"Standup Summary for $(date +'%Y-%m-%d') has been created: ${steps.create_summary_issue.outputs.issue-url}\"}" ${{ secrets.SLACK_WEBHOOK_URL }}
