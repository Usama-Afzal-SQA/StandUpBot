name: Send Standup Prompt

on:
  schedule:
    - cron: '0 6 * * 1-5'  # Adjust the time as needed
  workflow_dispatch:  # Allows manual triggering

jobs:
  send-standup-prompt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh -y

      - name: Post Main Message in Channel
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          # Post the standup message to the #test-bot channel
          RESPONSE=$(curl -s -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "{\"channel\":\"#test-bot\", \"text\":\"ðŸ“ Todayâ€™s standup summary for $(date +'%Y-%m-%d') has started. Please wait for your direct message and provide your response!\"}")

          # Extract the thread_ts (timestamp of the main message)
          THREAD_TS=$(echo $RESPONSE | jq -r '.ts')

          # Save the thread_ts for future workflows
          echo "THREAD_TS=$THREAD_TS" >> $GITHUB_ENV

      - name: Get DM Channel for Each User
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          USERS=("U066LTEPJF7")  # Add more users as needed

          for USER in "${USERS[@]}"; do
            # Open a DM channel with the user
            DM_CHANNEL_RESPONSE=$(curl -s -X POST https://slack.com/api/conversations.open \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-type: application/json" \
              --data "{\"users\":\"$USER\"}")

            # Extract the DM channel ID
            DM_CHANNEL_ID=$(echo $DM_CHANNEL_RESPONSE | jq -r '.channel.id')

            # Save the DM channel ID for future workflows
            echo "$USER:$DM_CHANNEL_ID" >> dm_channels.txt

            # Send a DM to the user asking for standup information
            curl -s -X POST https://slack.com/api/chat.postMessage \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-type: application/json" \
              --data "{\"channel\":\"$DM_CHANNEL_ID\", \"text\":\"Good morning! Please provide your standup response:\n\nYesterday Tasks:\nToday Tasks:\nAny Blockers?\"}"
          done

      - name: Save DM Channel Info for Later
        run: |
          # Commit the dm_channels.txt file so it can be used by the response capturing workflow
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add dm_channels.txt
          git commit -m "Save DM channels for response capture"
          git push
